<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' 'unsafe-eval';">
    <title>PUI - Casiers zone départ</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/print.css">
    <link rel="stylesheet" href="css/admintools.css">
</head>
<body>
    <div id="loginPage" class="login-container active">
        <div class="login-box">
            <h1>PUI - Casiers zone départ</h1>
            <form id="loginForm">
                <div class="form-group" id="userNameGroup" style="display: none;">
                    <input type="text" id="userName" placeholder="Votre nom ou initiales" autocomplete="off">
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" placeholder="Mot de passe (optionnel)" autocomplete="off">
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Se connecter</button>
                <button type="button" class="btn-secondary" style="width: 100%; margin-top: 10px;" onclick="loginAsGuest()">Visualiser les casiers</button>
            </form>
        </div>
    </div>

    <div class="container" id="appContainer" style="display: none;">
        <header>
            <div class="header-info">
                <div>
                    <h1>PUI - Casiers zone départ</h1>
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <div id="authStatus" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
                        <div class="admin-only" id="importStatus" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div id="serverStatus" class="server-status offline">⚪ Vérification...</div>
                    <button class="btn-secondary btn-small" onclick="logout()">Déconnexion</button>
                </div>
            </div>
            <div class="search-bar">
                <input type="text" id="globalSearch" placeholder="Rechercher par nom, prénom ou IPP...">
                <button class="btn-secondary admin-only" onclick="importClients()" title="Importer les admissions depuis un export MH">⬆️ Import patients</button>
                <button class="btn-settings admin-only" onclick="toggleAdminTools()" title="Outils d'administration" id="btnSettings">⚙️</button>
            </div>
        </header>

        <!-- CONTAINER OUTILS ADMIN (masqué par défaut) -->
        <div class="admin-tools-container admin-only" id="adminTools">
            <div class="admin-tools-header">
                <h3>🛠️ Outils d'administration</h3>
                <button class="btn-secondary btn-small" onclick="toggleAdminTools()" style="padding: 4px 8px; font-size: 11px;">Fermer</button>
            </div>
            <div class="admin-tools-content">
                <button class="btn-secondary" onclick="importCSV()" title="Importer des données casiers depuis un CSV">
                    ⬆️ Import casiers
                </button>
                <button class="btn-secondary" onclick="exportData('json')" title="Exporter les casiers au format JSON">
                    ⬇ Export JSON
                </button>
                <button class="btn-secondary" onclick="exportData('csv')" title="Exporter les casiers au format CSV">
                    ⬇ Export CSV
                </button>
                <button class="btn-secondary" onclick="createBackup()" title="Créer un backup manuel de la base Sqlite">
                    💾 Backup base
                </button>
                <button class="btn-secondary" onclick="showRestorePanel()" title="Restaurer la base depuis un backup">
                    🔄 Restore base
                </button>
                <button class="btn-secondary" onclick="showDuplicatesPanel()" title="Afficher la liste des doublons détectés">
                    ⚠️ Analyse doublons
                </button>
                <button class="btn-secondary" onclick="showHomonymsPanel()" title="Afficher la liste des homonymes détectés">
                    👥 Analyse homonymes
                </button>
                <button class="btn-secondary" onclick="showClientsStats()" title="Afficher les statistiques de la base clients">
                    📊 Stats clients
                </button>
                <button class="btn-secondary" onclick="showConnectionStats()" title="Afficher les statistiques de connexion">
                    📈 Stats connexions
                </button>
                
                <!-- Dark Mode Toggle -->
                <div class="dark-mode-selector" title="Changer le mode d'affichage">
                    <button class="mode-btn" data-mode="inactive" onclick="setDarkMode('inactive')">
                        <span class="icon">☀️</span>
                        <span class="label">Clair</span>
                    </button>
                    <button class="mode-btn" data-mode="system" onclick="setDarkMode('system')">
                        <span class="icon">💻</span>
                        <span class="label">Auto</span>
                    </button>
                    <button class="mode-btn" data-mode="active" onclick="setDarkMode('active')">
                        <span class="icon">🌙</span>
                        <span class="label">Sombre</span>
                    </button>
                </div>


            </div>
        </div>

        <!-- ONGLETS (seront générés dynamiquement) -->
        <div class="tabs"></div>

        <!-- CONTENU (sera généré dynamiquement) -->
        <div id="dynamicContent"></div>

        <!-- FOOTER -->
        <footer class="app-footer">
            <p>© 2025, C.Vinson & Sonnet 4.5</p>
        </footer>        
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Attribuer un casier</div>
            <div id="statusMessage"></div>
            <form id="lockerForm">
                <div class="form-group">
                    <label for="zone">Zone</label>
                    <select id="zone" required>
                        <option value="NORD">NORD</option>
                        <option value="SUD">SUD</option>
                        <option value="PCA">PCA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lockerNumber">N° Casier</label>
                    <select id="lockerNumber" required></select>
                </div>
                <div class="form-group">
                    <label for="lastName">Nom</label>
                    <input type="text" id="lastName" required>
                </div>
                <div class="form-group">
                    <label for="firstName">Prénom</label>
                    <input type="text" id="firstName" required>
                </div>
                <div class="form-group">
                    <label for="code">N°IPP</label>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <input type="text" id="code" required style="flex: 1; margin: 0;">
                        <button type="button" class="btn-secondary" onclick="searchClient()" style="white-space: nowrap; flex-shrink: 0; padding: 10px 12px;">🔍 Rechercher</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="birthDate">DDN</label>
                    <input type="date" id="birthDate" required>
                </div>
                <div class="form-group">
                    <label for="comment">Commentaire (optionnel)</label>
                    <textarea id="comment" rows="2" placeholder="Notes, remarques..."></textarea>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="recoverable" style="margin-right: 8px; width: auto;">
                        <span>Récupérable (en cas de pénurie)</span>
                    </label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

<!-- Panel stats clients -->
    <div id="clientsStatsPanel" class="clients-stats-panel">
        <div class="clients-stats-content">
            <div class="clients-stats-header">
                <h2>📊 Base de données clients</h2>
                <button class="btn-secondary" onclick="closeClientsStats()">✕</button>
            </div>
            
            <div id="clientsStatsContent">
                <p style="text-align: center; color: var(--text-secondary);">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- Panel restore -->
    <div id="restorePanel" class="restore-panel">
        <div class="restore-content">
            <div class="restore-header">
                <h2>🔄 Restaurer la base de données</h2>
                <button class="btn-secondary" onclick="closeRestorePanel()">✕</button>
            </div>

            <div class="warning-box">
                <div class="icon">⚠️</div>
                <div class="content">
                    <p><strong>ATTENTION : Opération critique !</strong></p>
                    <p>La restauration remplacera <strong>TOUTES les données actuelles</strong> par celles du backup sélectionné.</p>
                    <p>Cette action est <strong>IRRÉVERSIBLE</strong>. Un backup automatique sera créé avant la restauration.</p>
                </div>
            </div>

            <div id="restoreContent">
                <p style="text-align: center; color: var(--text-secondary);">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- Panel stats connexions -->
    <div id="connectionStatsPanel" class="connection-stats-panel">
        <div class="connection-stats-content">
            <div class="connection-stats-header">
                <h2>📈 Statistiques de connexion</h2>
                <button class="btn-secondary" onclick="closeConnectionStats()">✕</button>
            </div>
            
            <div id="connectionStatsContent">
                <p style="text-align: center; color: var(--text-secondary);">Chargement...</p>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Fonction pour toggle le container des outils admin
        function toggleAdminTools() {
            const container = document.getElementById('adminTools');
            const btn = document.getElementById('btnSettings');
            
            if (container && btn) {
                container.classList.toggle('active');
                btn.classList.toggle('active');
            }
        }
    </script>
</body>
</html>