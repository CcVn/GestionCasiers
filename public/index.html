<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' 'unsafe-eval';">
    <title>HADO - Casiers PUI zone d√©part</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dropdown-menu.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/print.css">
    <link rel="stylesheet" href="css/admintools.css">
</head>
<body>
    <!-- =========================== Page Login =================================== -->
    <div id="loginPage" class="login-container active">
        <div class="login-box">
            <h1>HADO - Casiers PUI zone d√©part</h1>
            <form id="loginForm">
                <button type="button" class="btn-primary" style="width: 100%; margin-top: 10px; font-size: 1.25rem; height: 75px; " onclick="loginAsGuest()">üëÅÔ∏è Chercher un casier</button>
                <div class="separator"></div>
                <div id="login_admin">
                    <p style="font-size: 16px; margin-bottom: 1rem;"><strong>Modification des casiers par la PUI</strong></p>
                    <div class="form-group" id="userNameGroup" style="display: block;">
                        <p><small style="color: var(--text-secondary);">Identifiant libre: nom, initiales, ... Adresse r√©seau par d√©faut</small></p>
                        <input type="text" id="userName" placeholder="Identifiant (optionnel, adresse IP par d√©faut)" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <!-- <p><small style="color: var(--text-secondary);">Mot de passe requis.</small></p> -->
                        <input type="password" id="loginPassword" placeholder="Mot de passe requis" autocomplete="off">
                    </div>
                </div>
                <button type="submit" class="btn-secondary" style="width: 100%;">üîê Modifier les casiers</button>
            </form>
        </div>
    </div>

    <div class="container" id="appContainer" style="display: none;">
        <!-- =========================== En-t√™te de page =================================== -->
        <header>
            <div class="header-info">
                <div>
                    <h1>HADO - Casiers PUI zone d√©part</h1>
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <div id="authStatus" style="font-size: 16px; color: #666; margin-top: 5px;"></div>
                        <div class="server-status2 admin-only" id="importStatus" style="font-size: 14px; color: #666; margin-top: 5px;"><span class="status-dot"></span></div>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <button class="btn-theme-toggle" onclick="toggleDarkModeQuick()" id="btnThemeToggle" title="Changer le th√®me">
                        <span class="theme-icon">üåì</span>
                    </button>
                    <div id="serverStatus" class="server-status offline" title="Etat de la connection avec le serveur">‚ö™ V√©rification...</div>
                    <button class="btn-settings admin-only" onclick="toggleAdminTools()" title="Outils d'administration" id="btnSettings">‚öôÔ∏è</button>
                    <button class="btn-secondary btn-small" onclick="logout()" title="Retourner √† la page de connexion">D√©connexion</button>
                </div>
            </div>
            <div class="search-bar">
                <input type="text" id="globalSearch" class="pulse" placeholder="Rechercher par nom, pr√©nom ou IPP...">
                <button class="btn-clearsearch" onclick="clearSearch()" style="background: #FF5C5C !important;" title="Vider la recherche"> ‚úï </button>
                <button class="btn-secondary admin-only" id="btnToggleMarkResults" onclick="toggleMarkSearchResults()" style="display: none;" title="Marquer/d√©marquer les casiers trouv√©s de l'onglet recherche üîç">üîñ</button>
                <button class="btn-secondary admin-only" onclick="importClients()" title="Importer les patients pr√©sents depuis un export MH ou autre" id="btnImportPat1">‚¨ÜÔ∏è Patients</button>
            </div>
        </header>

        <!-- =========================== CONTAINER OUTILS ADMIN ======================================= -->
        <div class="admin-tools-container admin-only" id="adminTools">
            <div class="admin-tools-header">
                <h3>üõ†Ô∏è Outils d'administration</h3>
                <button class="btn-secondary btn-small" onclick="toggleAdminTools()" style="padding: 4px 8px; font-size: 11px;">‚ùå</button>
            </div>
            <div class="admin-tools-content">
                <fieldset class="group-box">
                    <legend>Outils</legend>
                    <div class="buttons-container" id="blocSettings" title="Outils">
                        <button class="btn-secondary" onclick="showLabelPrintDialog()" title="Imprimer des √©tiquettes">
                            üè∑Ô∏è √âtiquettes
                        </button>
                    </div>
                </fieldset>
                <fieldset id="blocAnalyseCasiers" class="group-box">
                    <legend>Casiers</legend>
                    <div class="buttons-container" title="Contr√¥le des casiers">
                        <button class="btn-secondary" onclick="openConsultationCasiers('had')">üëÅÔ∏è Vues</button>
                        <button class="btn-secondary" onclick="showModificationStats()" title="Afficher les statistiques de modifications">
                            üìù Modif.
                        </button>
                        <button class="btn-secondary" onclick="clearAllMarks()" title="Retirer toutes les marques des casiers">
                            üîñ‚ÜíüóëÔ∏è 
                        </button>
                        <button class="btn-secondary" onclick="clearLockersDatabase()" title="Vider tous les casiers">Casiers‚ÜíüóëÔ∏è</button>
                        <button style="display: none;" class="btn-small" onclick="openConsultationCasiers('idel')">‚ÑπÔ∏è IDEL</button>
                        <button style="display: none;" class="btn-small" onclick="openConsultationCasiers('hosp')">üè• Hospitalisations</button>
                        <button style="display: none;" class="btn-small" onclick="openConsultationCasiers('stup')">üíä Stup√©fiants</button>
                        <button style="display: none;" class="btn-small" onclick="openConsultationCasiers('marked')">üîñ Marqu√©s</button>
                        <button style="display: none;" class="btn-small" onclick="openConsultationCasiers('duplicates')">‚ö†Ô∏è Doublons</button>
                        <button style="display: none;" class="btn-small" onclick="openConsultationCasiers('homonyms')">üë• Homonymes</button>
                        <button style="display: none;" class="btn-small" onclick="openConsultationCasiers('frigo')">‚ùÑ Frigo</button>
                        <button style="display: none;" class="btn-small" onclick="openConsultationCasiers('pca')">üíâ PCA</button>
                        <button style="display: none;" class="btn-small" onclick="openConsultationCasiers('meopa')">‚õΩÔ∏è MEOPA</button>
                    </div>
                </fieldset>
                <fieldset id="blocImportExport" class="group-box">
                    <legend>Import/Export des casiers</legend>
                    <div class="buttons-container" title="Export des casiers">
                        <button class="btn-secondary" onclick="showLockersExportOptions()" title="Exporter les casiers avec options">
                            ‚¨á Export
                        </button>
                        <button class="btn-secondary" onclick="showLockersImportOptions()" title="Importer des casiers">
                                ‚¨ÜÔ∏è Import
                        </button>
                    </div>
                </fieldset>
                <fieldset id="blocPatients" class="group-box">
                    <legend>Patients</legend>
                    <div class="buttons-container" title="Patients">
                       <button class="btn-secondary" onclick="importClients()" title="Importer les patients pr√©sents depuis un export MH ou Winpharm">
                            ‚¨ÜÔ∏è Import
                       </button>
                       <button class="btn-secondary" onclick="showAnonymizationConfig()" title="Configurer l'anonymisation">
                            üé≠ Anon.
                        </button>
                        <button class="btn-secondary" onclick="showClientsStats()" title="Afficher les statistiques de la base patients">
                            üìä Stats
                        </button>
                        <!--<button class="btn-secondary" onclick="clearClientsDatabase()" title="Vider la base patients">üßπ Vider la base</button> -->
                    </div>
                </fieldset>
                <fieldset id="blocConnexions" class="group-box">
                    <legend>Connexions</legend>
                    <div class="buttons-container" title="Statistiques">
                        <button class="btn-secondary" onclick="showConnectionStats()" title="Afficher les statistiques de connexion">
                            üìà Stats
                        </button>
                    </div>
                </fieldset>
                <fieldset id="blocBackups" class="group-box">
                    <legend>Backup SQLite</legend>
                    <div class="buttons-container">
                        <button class="btn-secondary" onclick="createBackup()" title="Cr√©er un backup manuel de la base Sqlite">
                            üíæ Sauver
                        </button>
                        <button class="btn-secondary" onclick="showRestorePanel()" title="Restaurer la base depuis un backup">
                            üîÑ Restaurer
                        </button>
                        <button class="btn-secondary" onclick="showBackupInfo()" title="Stats backup">
                            üïõÔ∏è Infos
                        </button>
                    </div>
                </fieldset>
                <fieldset id="blocInterface" class="group-box">
                    <legend>Interface</legend>
                    <!-- Dark Mode Toggle -->
                    <div class="dark-mode-selector" title="Changer le mode d'affichage">
                        <button class="mode-btn" data-mode="inactive" title="Th√®me clair" onclick="setDarkMode('inactive')">
                            <span class="icon">‚òÄÔ∏è</span>
                            <span class="label">Clair</span>
                        </button>
                        <button class="mode-btn" data-mode="system" title="Th√®me de l'OS" onclick="setDarkMode('system')">
                            <span class="icon">üíª</span>
                            <span class="label">Auto</span>
                        </button>
                        <button class="mode-btn" data-mode="active" title="Th√®me sombre" onclick="setDarkMode('active')">
                            <span class="icon">üåô</span>
                            <span class="label">Sombre</span>
                        </button>
                    </div>
                </fieldset>
            </div>
        </div>

        <!-- ONGLETS (seront g√©n√©r√©s dynamiquement) -->
        <div class="tabs"></div>

        <!-- CONTENU (sera g√©n√©r√© dynamiquement) -->
        <div id="dynamicContent"></div>

        <!-- FOOTER -->
        <footer class="app-footer">
            <p>Version 0.9, C.Vinson, Oct-Nov 2025</p>
        </footer>        
    </div>

    <!-- ======================  MODAL ATTRIBUER/MODIFIER CASIER ========================== -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Attribuer un casier</div>
            <div id="statusMessage"></div>
            <form id="lockerForm">
                <!-- Zone et Num√©ro sur la m√™me ligne -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="zone">Zone</label>
                        <select id="zone" required>
                            <option value="Zone1">Zone1</option>
                            <!-- Sera rempli dynamiquement -->
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="lockerNumber">N¬∞ Casier</label>
                        <select id="lockerNumber" required></select>
                    </div>
                </div>
                
                <!-- Nom et Pr√©nom sur la m√™me ligne -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="lastName">Nom</label>
                        <input type="text" id="lastName" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="firstName">Pr√©nom</label>
                        <input type="text" id="firstName" required>
                    </div>
                </div>
                
                <!-- IPP, DDN et Bouton Rechercher sur la m√™me ligne -->
                <div style="display: grid; grid-template-columns: 2fr 2fr auto; gap: 10px; align-items: end;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="birthDate">DDN</label>
                        <input type="date" id="birthDate" required>
                    </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                        <label for="code">N¬∞IPP</label>
                        <input type="text" id="code" required>
                    </div>
                    <button type="button" class="btn-secondary" onclick="searchClient()" style="white-space: nowrap; padding: 10px 12px; margin-bottom: 0;">üîç Rech.</button>
                </div>
                <!-- Commentaire -->
                <div class="form-group">
                    <label for="comment">Commentaire (optionnel)</label>
                    <textarea id="comment" rows="2" placeholder="Notes, remarques..."></textarea>
                </div>
                <!-- Checkboxes sur 2 colonnes -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px 20px;">
                    <!-- Colonne 1 -->
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="recoverable" style="margin-right: 8px; width: auto;">
                            <span>R√©cup√©rable?</span>
                        </label>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="stup" style="margin-right: 8px; width: auto;">
                            <span>üíä Stup√©fiants</span>
                        </label>
                    </div>
                    <!-- Colonne 2 -->
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="idel" style="margin-right: 8px; width: auto;">
                            <span>‚ÑπÔ∏è IDEL/AS</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="frigo" style="margin-right: 8px; width: auto;">
                            <span>‚ùÑÔ∏è Frigo</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="pca" style="margin-right: 8px; width: auto;">
                            <span>üíâ PCA</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="meopa" style="margin-right: 8px; width: auto;">
                            <span>‚õΩÔ∏è MEOPA</span>
                        </label>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!--   ==============================  MODAL D'IMPORT PATIENTS  ============================== -->
    <div id="importOptionsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">üì• Options d'import clients</div>
            
            <form id="importOptionsForm">
                <!-- Mode d'import : fusionner ou remplacer -->
                <div class="form-group">
                    <label for="importMode">Mode d'import</label>
                    <select id="importMode" required>
                        <option value="replace">üîÑ Remplacer (vider puis importer)</option>
                        <option value="merge">‚ûï Fusionner (ajouter sans supprimer)</option>
                    </select>
                    <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                        Mode "Fusionner" : les doublons (m√™me IPP) seront ignor√©s
                    </small>
                </div>
                <div id="importWarning" style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 12px; margin: 16px 0; display: none;">
                    <strong style="color: #92400e;">‚ö†Ô∏è Information importante :</strong>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: #78350f;">
                        Le mode "Remplacer" va supprimer tous les patients existants dans la base avant l'import du nouveau fichier. C'est le mode √† privil√©gier pour ne pas avoir en base des patients qui ne sont plus pr√©sents. A n'effectuer que si la nouvelle liste des admissions est un export complet du logiciel source.
                    </p>
                </div>

                <!-- Type de fichier source -->
                <div class="form-group">
                    <label for="importFormat">Format du fichier</label>
                    <select id="importFormat" required>
                        <!-- Sera rempli dynamiquement -->
                    </select>
                    <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                        Le format par d√©faut est configur√© dans les param√®tres serveur
                    </small>
                </div>

                <!-- Separateur de champs import patients -->
                <div class="form-group" id="importSeparatorGroup">
                    <label for="importSeparator">S√©parateur de champs</label>
                    <select id="importSeparator" required>
                        <option value="auto">üîç D√©tection automatique (recommand√©)</option>
                        <option value=";">Point-virgule (;) - Excel FR</option>
                        <option value=",">Virgule (,) - Standard</option>
                        <option value="|">Pipe (|)</option>
                        <option value=" ">Tabulation</option>
                    </select>
                    <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                        Choisissez le s√©parateur utilis√© dans votre fichier CSV. La d√©tection automatique analyse votre fichier pour essayer de d√©terminer le bon s√©parateur
                    </small>
                </div>
                
                <!-- Bouton pour effacer la base patients -->
                <div style="border-top: 1px solid var(--border-color); margin-top: 20px; padding-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="clearClientsDatabase()" style="width: 100%; background: #fee2e2; color: #991b1b; border-color: #fecaca;">
                        üóëÔ∏è Vider la base clients
                    </button>
                    <p style="font-size: 11px; color: var(--text-tertiary); margin: 8px 0 0 0; text-align: center;">
                        Supprime tous les clients de la base de donn√©es
                    </p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeImportOptions()">Annuler</button>
                    <button type="button" class="btn-primary" onclick="selectFileForImport()">Choisir le fichier</button>
                </div>
            </form>
        </div>
    </div>
    
    <input type="file" id="clientFileInput" accept=".csv" style="display: none;">

    <!-- ==============================  MODAL IMPORT CASIERS  ============================== -->
    <div id="lockersImportOptionsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">‚¨ÜÔ∏è Options d'import casiers</div>
            
            <div style="padding: 20px;">
                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 12px; margin-bottom: 20px;">
                    <strong style="color: #92400e;">‚ÑπÔ∏è Import de casiers</strong>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: #78350f;">
                        Importez des casiers depuis un fichier CSV ou JSON.
                    </p>
                </div>
                
                <form id="lockersImportOptionsForm">
                    <div class="form-group">
                        <label for="lockersImportMode">Mode d'import</label>
                        <select id="lockersImportMode" required>
                            <option value="update">üìù Mise √† jour (remplace les casiers existants)</option>
                            <option value="replace">üóëÔ∏è Remplacement complet (vide puis importe)</option>
                        </select>
                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                            Mode "Mise √† jour" : ne modifie que les casiers pr√©sents dans le fichier<br>
                            Mode "Remplacement" : vide TOUS les casiers puis importe
                        </small>
                    </div>
                    
                    <div id="lockersImportWarning" style="background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; padding: 12px; margin: 16px 0; display: none;">
                        <strong style="color: #991b1b;">‚ö†Ô∏è Attention :</strong>
                        <p style="margin: 4px 0 0 0; font-size: 13px; color: #7f1d1d;">
                            Le mode "Remplacement complet" va lib√©rer TOUS les casiers avant l'import.
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="lockersImportFormat">Format du fichier</label>
                        <select id="lockersImportFormat" required>
                            <option value="csv">CSV (format standard)</option>
                            <option value="json">JSON (export backup)</option>
                        </select>
                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                            Le CSV doit contenir les colonnes : N¬∞Casier, Zone, Nom, Pr√©nom, IPP, DDN, R√©cup√©rable, Marque, Hosp, DateHosp, Stup, IDEL, Commentaire
                        </small>
                    </div>

                    <!-- Separateur -->
                    <div class="form-group" id="importLockersSeparatorGroup">
                        <label for="lockersImportSeparator">S√©parateur de champs pour format CSV</label>
                        <select id="lockersImportSeparator" required>
                            <option value="auto">üîç D√©tection automatique (recommand√©)</option>
                            <option value=",">Virgule (,) - Standard</option>
                            <option value=";">Point-virgule (;) - Excel FR</option>
                            <option value="|">Pipe (|)</option>
                            <option value=" ">Tabulation</option>
                        </select>
                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                            Choisissez le s√©parateur utilis√© dans votre fichier CSV. La d√©tection automatique analyse votre fichier pour essayer de d√©terminer le bon s√©parateur
                        </small>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeLockersImportOptions()">Annuler</button>
                        <button type="button" class="btn-primary" onclick="selectFileForLockersImport()">Choisir le fichier</button>
                    </div>
                </form>
                
                <!-- Bouton pour vider la base casiers -->
                <div style="border-top: 1px solid var(--border-color); margin-top: 20px; padding-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="clearLockersDatabase()" style="width: 100%; background: #fee2e2; color: #991b1b; border-color: #fecaca;">
                        üóëÔ∏è Vider tous les casiers
                    </button>
                    <p style="font-size: 11px; color: var(--text-tertiary); margin: 8px 0 0 0; text-align: center;">
                        Lib√®re tous les casiers de toutes les zones
                    </p>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="lockersFileInput" accept=".csv,.json" style="display: none;">

    <!-- ===========================  MODAL OPTIONS D'EXPORT CASIERS  ============================== -->
    <div id="exportOptionsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">‚¨á Options d'export</div>
            
            <form id="exportOptionsForm">
                <div class="form-group">
                    <label for="exportFormat">Format</label>
                    <select id="exportFormat" required>
                        <option value="csv">CSV (tableur)</option>
                        <option value="json">JSON (backup complet)</option>
                    </select>
                    <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                        JSON inclut les m√©tadonn√©es d'export
                    </small>
                </div>
                
                <div class="form-group" id="exportLockersSeparatorGroup">
                    <label for="exportSeparator">S√©parateur CSV</label>
                    <select id="exportSeparator" required>
                        <option value=";">Point-virgule (;) + BOM - Excel FR</option>
                        <option value=",">Virgule (,) sans BOM - Standard</option>
                        <option value="|">Pipe (|) sans BOM</option>
                        <option value=" ">Tabulation sans BOM</option>
                    </select>
                    <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                        Recommand√© : point-virgule pour Excel fran√ßais
                    </small>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="exportIncludeEmpty" style="margin-right: 8px; width: auto; cursor: pointer;">
                        <span>Inclure les casiers vides</span>
                    </label>
                    <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                        Par d√©faut : uniquement les casiers occup√©s
                    </small>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeExportOptions()">Annuler</button>
                    <button type="submit" class="btn-primary">‚¨á T√©l√©charger</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===========================  MODAL RESTORE BACKUP  ================================= -->
    <div id="restorePanel" class="restore-panel">
        <div class="restore-content">
            <div class="restore-header">
                <h2>üîÑ Restaurer la base de donn√©es</h2>
                <button class="btn-secondary" onclick="closeRestorePanel()">‚úï</button>
            </div>

            <div class="warning-box">
                <div class="icon">‚ö†Ô∏è</div>
                <div class="content">
                    <p><strong>ATTENTION : Op√©ration critique !</strong></p>
                    <p>La restauration remplacera <strong>TOUTES les donn√©es actuelles</strong> par celles du backup s√©lectionn√©.</p>
                    <p>Cette action est <strong>IRR√âVERSIBLE</strong>. Un backup automatique sera cr√©√© avant la restauration.</p>
                </div>
            </div>

            <div id="restoreContent">
                <p style="text-align: center; color: var(--text-secondary);">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- ===========================  MODAUX STATISTIQUES  ================================= -->
    <!-- -----------------------  Panel stats patients  ----------------------------- -->
    <div id="clientsStatsPanel" class="clients-stats-panel">
        <div class="clients-stats-content">
            <div class="clients-stats-header">
                <h2>üìä Base de donn√©es patients</h2>
                <button class="btn-secondary" onclick="closeClientsStats()">‚úï</button>
            </div>
            
            <div id="clientsStatsContent">
                <p style="text-align: center; color: var(--text-secondary);">Chargement...</p>
            </div>
        </div>
    </div>
    <!-- -----------------------  Panel stats connexions  ----------------------------- -->
    <div id="connectionStatsPanel" class="connection-stats-panel">
        <div class="connection-stats-content">
            <div class="connection-stats-header">
                <h2>üìà Statistiques de connexion</h2>
                <button class="btn-secondary" onclick="closeConnectionStats()">‚úï</button>
            </div>
            
            <div id="connectionStatsContent">
                <p style="text-align: center; color: var(--text-secondary);">Chargement...</p>
            </div>
        </div>
    </div>
    <!-- ------------------------  Panel stats modifications  --------------------------- -->
    <div id="modificationStatsPanel" class="modification-stats-panel">
        <div class="modification-stats-content">
            <div class="modification-stats-header">
                <h2>üìù Statistiques de modifications</h2>
                <button class="btn-secondary" onclick="closeModificationStats()">‚úï</button>
            </div>
            
            <div id="modificationStatsContent">
                <p style="text-align: center; color: var(--text-secondary);">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- ===========================  MODAL CONFIGURATION ANONYMISATION  ============================== -->
    <div id="anonymizationConfigModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">üé≠ Configuration de l'anonymisation</div>
            
            <div style="padding: 20px;">
                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 12px; margin-bottom: 20px;">
                    <strong style="color: #92400e;">‚ö†Ô∏è Configuration temporaire</strong>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: #78350f;">
                        Ces param√®tres sont perdus au red√©marrage du serveur.<br>
                        Pour une configuration permanente, modifiez le fichier .env
                    </p>
                </div>
                
                <form id="anonymizationForm">
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="font-size: 14px; font-weight: 600; margin: 0 0 12px 0; color: var(--text-primary);">
                            üëÅÔ∏è Mode Guest (consultation)
                        </h3>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="anonymizeGuest" style="margin-right: 10px; width: auto; cursor: pointer;">
                            <span>Activer l'anonymisation en mode guest</span>
                        </label>
                        <p style="font-size: 12px; color: var(--text-secondary); margin: 8px 0 0 0;">
                            Si activ√© : <strong>DUP</strong> devient <strong>DUP</strong>, <strong>Jacques</strong> devient <strong>JA</strong>
                        </p>
                        <p style="font-size: 11px; color: var(--text-tertiary); margin: 4px 0 0 0;">
                            Valeur par d√©faut (.env) : <strong id="guestDefault">‚Äî</strong>
                        </p>
                    </div>
                    
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <h3 style="font-size: 14px; font-weight: 600; margin: 0 0 12px 0; color: var(--text-primary);">
                            üîí Mode Admin (modification)
                        </h3>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="anonymizeAdmin" style="margin-right: 10px; width: auto; cursor: pointer;">
                            <span>Activer l'anonymisation en mode admin</span>
                        </label>
                        <p style="font-size: 12px; color: var(--text-secondary); margin: 8px 0 0 0;">
                            Si activ√© : noms/pr√©noms partiellement masqu√©s m√™me en modification
                        </p>
                        <p style="font-size: 11px; color: var(--text-tertiary); margin: 4px 0 0 0;">
                            Valeur par d√©faut (.env) : <strong id="adminDefault">‚Äî</strong>
                        </p>
                    </div>
                    
                    <div id="anonymizationStatus" class="status-message" style="margin-bottom: 16px;"></div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeAnonymizationConfig()">Annuler</button>
                        <button type="submit" class="btn-primary">Appliquer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ===========================  MODAL IMPRESSION ETIQUETTES  ============================== -->
    <!-- Modal impression √©tiquettes -->
    <div id="labelPrintModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">üè∑Ô∏è Impression d'√©tiquettes</div>
            
            <div style="padding: 20px;">
                <div class="form-group" style="width: 100%; box-sizing: border-box;">
                    <label>Format d'√©tiquette</label>
                    <select id="labelFormat" onchange="updateLabelPreview()">
                        <option value="5x13">5 √ó 13 √©tiquettes (65 par page)</option>
                        <option value="3x9">3 √ó 9 √©tiquettes (27 par page)</option>
                    </select>
                </div>
                    
                <div class="form-group">
                    <label>S√©lection des casiers</label>
                    <select id="labelSelection" onchange="updateLabelPreview()">
                        <option value="all">Tous les casiers occup√©s</option>
                        <option value="zone">Tous les casiers occup√©s de la zone ...</option>
                        <option value="range">Tous les casiers occup√©s dans la plage de num√©ros...</option>
                    </select>
                </div>
                
                <!-- Options selon s√©lection -->
                <div id="zoneSelector" class="form-group" style="display: none;">
                    <label>Zone</label>
                    <select id="labelZone" onchange="updateLabelPreview()">
                        <!-- Sera rempli dynamiquement -->
                    </select>
                </div>
                
                <div id="rangeSelector" style="display: none;">
                    <div class="form-group">
                        <label>Du casier</label>
                        <input type="text" id="labelRangeStart" placeholder="Ex: N01" oninput="updateLabelPreview()">
                    </div>
                    <div class="form-group">
                        <label>Au casier</label>
                        <input type="text" id="labelRangeEnd" placeholder="Ex: N75" oninput="updateLabelPreview()">
                    </div>
                </div>
                
                <!-- NOUVEAU : Filtre par marqueurs -->
                <div class="form-group">
                    <label>Filtrer par marqueur (optionnel)</label>
                    <select id="labelMarkerFilter" onchange="updateLabelPreview()">
                        <option value="none">Aucun filtre</option>
                        <option value="marked">üîñ Casiers marqu√©s uniquement</option>
                        <option value="hosp">üè• Hospitalisations uniquement</option>
                        <option value="stup">üíä Stup√©fiants uniquement</option>
                        <option value="idel">‚ÑπÔ∏è IDEL/AS uniquement</option>
                        <option value="frigo">‚ùÑÔ∏è Frigo uniquement</option>
                        <option value="pca">üíâ PCA uniquement</option>
                        <option value="meopa">‚õΩÔ∏è MEOPA uniquement</option>
                    </select>
                    <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                        Ce filtre s'applique en plus de la s√©lection ci-dessus
                    </small>
                </div>
                
                <div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="number" id="labelRepetition" value="1" min="1" max="10" oninput="updateLabelPreview()" style="margin-right: 10px; width: auto;">
                            <span>Nombre de copies par casier</span>
                        </label>
                        <small style="display: flex; color: var(--text-secondary); font-size: 11px; margin-top: 2px;">
                            Entre 1 et 10 copies
                        </small>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="labelAnonymize" onchange="updateLabelPreview()" style="margin-right: 10px; width: auto;">
                            <span>Anonymiser les noms/pr√©noms</span>
                        </label>
                    </div>
                </div>

                <div style="background: var(--bg-secondary); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 14px;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">Casiers s√©lectionn√©s</div>
                            <div style="font-size: 20px; font-weight: 600; color: var(--primary-color);">
                                <span id="labelLockerCount">0</span>
                            </div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">Total √©tiquettes</div>
                            <div style="font-size: 20px; font-weight: 600; color: var(--primary-color);">
                                <span id="labelTotalCount">0</span>
                            </div>
                        </div>
                    </div>
                    <div id="labelPagesInfo" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); font-size: 13px; color: var(--text-secondary);">
                        <!-- Sera rempli dynamiquement -->
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeLabelPrintDialog()">Annuler</button>
                    <button type="button" class="btn-primary" onclick="openLabelPrintWindow()">üñ®Ô∏è Imprimer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===========================  MODAL IMPRESSION ETIQUETTE UNIQUE ============================== -->
    <div id="singleLabelModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">üè∑Ô∏è Imprimer √©tiquettes</div>
            
            <div style="padding: 20px;">
                <div id="singleLabelInfo" style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <!-- Sera rempli dynamiquement -->
                </div>
                
                <div class="form-group">
                    <label>Format d'√©tiquette</label>
                    <select id="singleLabelFormat">
                        <option value="3x9">3 √ó 9 (27 √©tiquettes)</option>
                        <option value="5x13">5 √ó 13 (65 √©tiquettes)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="singleLabelAnonymize" style="margin-right: 10px; width: auto;">
                        <span>Anonymiser les noms/pr√©noms</span>
                    </label>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeSingleLabelModal()">Annuler</button>
                    <button type="button" class="btn-primary" onclick="confirmPrintSingleLabel()">üñ®Ô∏è Imprimer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===========================  MODAL HOSPITALISATION ============================== -->
    <div id="hospitalisationModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">üè• Hospitalisation</div>
            
            <div style="padding: 20px;">
                <div id="hospitalisationInfo" style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <!-- Sera rempli dynamiquement -->
                </div>
                
                <form id="hospitalisationForm">
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="hospCheckbox" style="margin-right: 10px; width: auto; cursor: pointer;">
                            <span style="font-weight: 600;">Patient hospitalis√©</span>
                        </label>
                    </div>
                    
                    <div class="form-group" id="hospDateGroup" style="display: none;">
                        <label for="hospDateInput">Date d'hospitalisation</label>
                        <input type="date" id="hospDateInput">
                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                            Optionnel - Laissez vide si date inconnue
                        </small>
                    </div>
                    
                    <div id="hospitalisationStatus" class="status-message" style="margin-bottom: 16px;"></div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeHospitalisationModal()">Annuler</button>
                        <button type="submit" class="btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ===========================  MODAL CONSULTATION CASIERS ============================== -->
    <div id="consultationCasiersModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; font-size: 18px;">üîç Consultation globale (multi-zones) des casiers occup√©s</h2>
                <button class="btn-secondary btn-small" onclick="closeConsultationCasiers()" style="padding: 4px 8px; font-size: 11px;">‚úï</button>
            </div>
            
            <!-- Filtres -->
            <div style="display: flex; gap: 10px; margin: 16px 0; align-items: center; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="consultationFilter" style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Type de patients</label>
                    <select id="consultationFilter" onchange="updateConsultationTable()" style="width: 100%;">
                        <option value="idel">‚ÑπÔ∏è Patients IDEL+AS</option>
                        <option value="had">üë®‚Äç‚öïÔ∏è Patients 100% HAD</option>
                        <option value="hosp">üè• Patients hospitalis√©s</option>
                        <option value="stup">üíä Patients avec stup√©fiants</option>
                        <option value="frigo">‚ùÑÔ∏è Patients avec traitement frigo</option>
                        <option value="pca">üíâ Patients avec PCA</option>
                        <option value="meopa">‚õΩÔ∏è Patients avec MEOPA</option>
                        <option value="marked">üîñ Patients avec marque</option>
                        <option value="duplicates">‚ö†Ô∏è Doublons (IPP ou identit√©)</option>
                        <option value="homonyms">üë• Homonymes</option>
                    </select>
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <label for="consultationZone" style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Zone</label>
                    <select id="consultationZone" onchange="updateConsultationTable()" style="width: 100%;">
                        <option value="all">Toutes les zones</option>
                        <!-- Sera rempli dynamiquement -->
                    </select>
                </div>
                <div style="display: flex; align-items: flex-end; gap: 10px;">
                    <button id="btnDoub" style="display: block;" class="btn-secondary" onclick="showDuplicatesPanel()" title="Analyse des doublons">
                        ‚ö†Ô∏è
                    </button>
                    <button id="btnHom" style="display: block;" class="btn-secondary" onclick="showHomonymsPanel()" title="Analyse des homonymes">
                        üë•
                    </button>
                    <button id="btnHosp" style="display: block;" class="btn-secondary" onclick="showHospitalisationList()" title="Analyse des hospitalisations">
                        üè•
                    </button>
                    <button class="btn-secondary" onclick="exportConsultationCSV()" title="Exporter en CSV">
                        ‚¨á CSV
                    </button>
                    <button class="btn-secondary" onclick="printConsultationTable()" title="Imprimer">
                        üñ®Ô∏è Imprimer
                    </button>
                </div>
            </div>
            
            <!-- Compteur / overview -->
            <div style="padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 16px; font-size: 14px;">
                <strong id="consultationCount">0 patient(s)</strong> 
            </div>
            
            <!-- Table -->
            <div style="max-height: 500px; overflow-y: auto;">
                <table class="clients-preview-table" id="consultationTable">
                    <thead style="position: sticky; top: 0; background: var(--bg-primary); z-index: 10;">
                        <tr>
                            <th style="cursor: pointer;" onclick="sortConsultationTable('name')">Nom ‚ñº</th>
                            <th style="cursor: pointer;" onclick="sortConsultationTable('firstName')">Pr√©nom ‚ñº</th>
                            <th style="cursor: pointer;" onclick="sortConsultationTable('birthDate')">Date de naissance ‚ñº</th>
                            <th style="cursor: pointer;" onclick="sortConsultationTable('code')">N¬∞IPP ‚ñº</th>
                            <th style="cursor: pointer;" onclick="sortConsultationTable('number')">N¬∞ Casier ‚ñº</th>
                            <th>Commentaire</th>
                        </tr>
                    </thead>
                    <tbody id="consultationTableBody">
                        <!-- Rempli dynamiquement -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<!--    <script src="/js/admintools.js"></script> -->
<!--    <script src="modal_labels.js"></script>  -->
    <script src="app.js"></script>
<!--    <script src="modal_consultation.js"></script> -->
    <script>
        // Fonction pour toggle le container des outils admin
        function toggleAdminTools() {
            const container = document.getElementById('adminTools');
            const btn = document.getElementById('btnSettings');
            
            if (container && btn) {
                container.classList.toggle('active');
                btn.classList.toggle('active');
            }
        }
    </script>
</body>
</html>