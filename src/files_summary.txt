# üìÇ Liste Compl√®te des Fichiers Cr√©√©s

## üé¨ Fichier Principal

### `server.js` (60 lignes)
Point d'entr√©e qui orchestre tous les modules.
- Import des modules
- Configuration Express
- Montage des routes
- D√©marrage du serveur
- Initialisation des backups

---

## ‚öôÔ∏è Configuration (`src/config/`)

### `src/config/index.js` (85 lignes)
Configuration centrale de l'application.
- Mots de passe et authentification
- Anonymisation (guest/admin)
- Backups (heure, fr√©quence, r√©tention)
- Sessions (dur√©e, nettoyage)
- Mode production/d√©veloppement

### `src/config/zones.js` (45 lignes)
Configuration des zones de casiers.
- Parsing de ZONE_NAMES, ZONE_COUNTS, ZONE_PREFIXES
- Validation de la configuration
- Export de ZONES_CONFIG

### `src/config/import-formats.js` (70 lignes)
Formats d'import CSV personnalis√©s.
- Format INTERNE (par d√©faut)
- Format MHCARE (logiciel m√©dical)
- Format WINPHARM (logiciel pharmacie)
- Mapping des colonnes
- Filtres et validations

---

## üíæ Base de Donn√©es (`src/database/`)

### `src/database/index.js` (70 lignes)
Connexion SQLite et helpers.
- Connexion √† la base de donn√©es
- `dbRun()` : Ex√©cuter une requ√™te
- `dbGet()` : R√©cup√©rer une ligne
- `dbAll()` : R√©cup√©rer toutes les lignes
- Gestion des erreurs

### `src/database/init.js` (180 lignes)
Initialisation des tables.
- Table `lockers` (casiers)
- Table `clients` (patients)
- Table `locker_history` (historique)
- Table `connection_stats` (stats connexions)
- Table `connection_logs` (logs d√©taill√©s)
- Table `export_logs` (logs exports)
- Table `client_imports` (imports patients)
- Initialisation des casiers si vide

---

## üìã Mod√®les (`src/models/`)

### `src/models/schemas.js` (115 lignes)
Sch√©mas de validation Zod.
- `lockerSchema` : Validation casier
- `clientSchema` : Validation client/patient
- `importCasierSchema` : Import CSV casiers
- `restoreSchema` : Restauration backup
- `loginSchema` : Validation login

---

## üîß Services (`src/services/`)

### `src/services/session.js` (70 lignes)
Gestion des sessions en m√©moire.
- Map des sessions
- Cr√©ation/r√©cup√©ration de session
- Nettoyage automatique des sessions expir√©es
- Dur√©e de session configurable

### `src/services/history.js` (60 lignes)
Enregistrement des logs et historique.
- `recordConnection()` : Logger une connexion
- `recordHistory()` : Logger une modification de casier
- Statistiques agr√©g√©es par jour/r√¥le

### `src/services/csv-parser.js` (180 lignes)
Parsing CSV avec formats personnalis√©s.
- `parseCsvLine()` : Parser une ligne CSV
- `detectCSVSeparator()` : D√©tection automatique du s√©parateur
- `mapRowToClient()` : Mapper les colonnes
- `parseClientsWithFormat()` : Import complet avec format

### `src/services/locker-lock.js` (220 lignes)
Syst√®me de verrouillage (lock) des casiers en cours d'√©dition
- `acquireLock()` : Tente d'acqu√©rir un lock sur un casier
- `releaseLock()` : Lib√®re un lock sur un casier
- `checkLock()` : V√©rifie si un casier est verrouill√©
- `renewLock()` : Renouvelle un lock existant (heartbeat)
- `cleanExpiredLocks()` : Nettoie tous les locks expir√©s
- `listActiveLocks()` : Liste tous les locks actifs
- `forceReleaseLock()` : Force la lib√©ration d'un lock (admin seulement)

---

## üõ°Ô∏è Middleware (`src/middleware/`)

### `src/middleware/index.js` (90 lignes)
Configuration des middlewares Express.
- CORS (cross-origin)
- Body parser (JSON)
- Cookie parser
- CSRF protection
- Helmet (s√©curit√© headers)
- Rate limiting
- Fichiers statiques (public/)
- Route par d√©faut (index.html)

### `src/middleware/auth.js` (35 lignes)
Middleware d'authentification.
- `requireAuth()` : V√©rifier l'authentification
- V√©rification de l'expiration de session
- Renouvellement automatique (rolling session)

### `src/middleware/rate-limit.js` (60 lignes)
Rate limiters pour prot√©ger l'API.
- `generalLimiter` : 100 req/5min (toutes routes)
- `loginLimiter` : 5 req/5min (login)
- `importLimiter` : 100 req/heure (imports)
- `exportLimiter` : 20 req/15min (exports)
- `backupLimiter` : 5 req/heure (backups)

---

## üõ§Ô∏è Routes API (`src/routes/`)

### `src/routes/auth.js` (170 lignes)
Authentification et sessions.
- `GET /api/csrf-token` : Token CSRF
- `POST /api/login` : Login admin/guest
- `POST /api/logout` : D√©connexion
- `GET /api/auth/check` : V√©rifier session
- `GET /api/session/time-remaining` : Temps restant

### `src/routes/lockers.js` (450 lignes)
Gestion compl√®te des casiers.
- `GET /api/lockers` : Tous les casiers
- `GET /api/lockers/zone/:zone` : Par zone
- `GET /api/lockers/:number` : Un casier
- `POST /api/lockers` : Cr√©er/modifier
- `POST /api/lockers/bulk-mark` : Marquage multiple
- `DELETE /api/lockers/clear-marks` : Retirer toutes marques
- `POST /api/lockers/:number/toggle/:marker` : Toggle marqueur
- `POST /api/lockers/:number/hospitalisation` : Modifier hosp
- `DELETE /api/lockers/:number` : Lib√©rer casier
- `DELETE /api/lockers/clear` : Vider tous casiers
- `GET /api/lockers/search/:query` : Recherche
- `GET /api/lockers/:number/history` : Historique

### `src/routes/clients.js` (200 lignes)
Import et gestion des clients/patients.
- `GET /api/clients/import-status` : Statut import
- `GET /api/clients/stats` : Statistiques
- `GET /api/clients/:ipp` : Un client
- `POST /api/clients/import` : Import CSV
- `DELETE /api/clients/clear` : Vider base clients

### `src/routes/stats.js` (150 lignes)
Statistiques et rapports.
- `GET /api/stats` : Stats g√©n√©rales
- `GET /api/stats/connections` : Stats connexions
- `GET /api/stats/connections/summary` : R√©sum√© connexions
- `GET /api/stats/modifications` : Stats modifications

### `src/routes/export.js` (120 lignes)
Export de donn√©es.
- `POST /api/export` : Export CSV/JSON
- `POST /api/exports/log` : Logger un export
- `GET /api/exports/history` : Historique exports

### `src/routes/import.js` (280 lignes)
Import de donn√©es.
- `POST /api/import` : Import CSV casiers
- `POST /api/import-json` : Import JSON casiers

### `src/routes/backup.js` (170 lignes)
Gestion des sauvegardes.
- `GET /api/backups` : Liste backups
- `POST /api/restore` : Restaurer backup
- `POST /api/backup` : Cr√©er backup manuel

### `src/routes/config.js` (120 lignes)
Configuration runtime.
- `GET /api/config/zones` : Configuration zones
- `GET /api/config/anonymization` : Config anonymisation
- `POST /api/config/anonymization` : Modifier anonymisation
- `GET /api/config/import-format` : Format import
- `GET /api/config/backup` : Config backup
- `GET /api/config` : Config g√©n√©rale

---

## üî® Utilitaires

### `src/utils/misc-utils.js` (85 lignes)
Fonctions utilitaires r√©utilisables.
- `generateToken()` : G√©n√©rer token s√©curis√©
- `getLocalIP()` : IP locale du serveur
- `getClientIP()` : IP du client
- `normalizeDateFormat()` : Normaliser dates
- `capitalizeFirstLetter()` : Premi√®re lettre maj

### `src/utils/auto-backup.js` (110 lignes)
Service de backup automatique.
- Backup √† heure fixe (ex: 02:00)
- Backup p√©riodique (ex: toutes les 24h)
- Nettoyage des vieux backups
- R√©tention configurable

Ajout de 3 autres fichiers
- csv-cleaner.js
- date.js
- winpharm-parser.js


---

## üìö Documentation

### `README_REFACTORING.md`
Documentation compl√®te de l'architecture.
- Structure des fichiers
- Explications de chaque module
- Avantages du refactoring
- Guide de maintenance

### `MIGRATION.md`
Guide pas √† pas pour migrer.
- Checklist de migration
- Tests de validation
- R√©solution de probl√®mes
- V√©rification finale

### `package.json`
D√©pendances du projet.
- Express, SQLite3, Bcrypt
- Helmet, CORS, CSRF
- Zod, Rate-limit
- Scripts npm

---

## üìä Statistiques du Refactoring

| M√©trique | Avant | Apr√®s |
|----------|-------|-------|
| **Nombre de fichiers** | 1 | 26 |
| **Lignes par fichier** | 1500+ | 35-450 |
| **Maintenabilit√©** | ‚ö†Ô∏è Difficile | ‚úÖ Excellente |
| **Testabilit√©** | ‚ö†Ô∏è Compliqu√©e | ‚úÖ Simple |
| **R√©utilisabilit√©** | ‚ùå Nulle | ‚úÖ Maximale |
| **Lisibilit√©** | ‚ö†Ô∏è Moyenne | ‚úÖ Optimale |

---

## ‚úÖ R√©sum√©

**Total : 26 fichiers cr√©√©s**

- 1 fichier principal (`server.js`)
- 3 fichiers de configuration
- 2 fichiers de base de donn√©es
- 1 fichier de mod√®les
- 3 fichiers de services
- 3 fichiers de middleware
- 8 fichiers de routes
- 2 fichiers utilitaires
- 3 fichiers de documentation

**Comportement : 100% identique √† l'original**

Tous les endpoints API, fonctionnalit√©s et comportements sont pr√©serv√©s. Seule l'organisation du code a chang√© pour faciliter la maintenance future.
