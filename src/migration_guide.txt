# ğŸ”„ Guide de Migration - Ancien Code â†’ Code RefactorisÃ©

## ğŸ“‹ Checklist de Migration

### âœ… Ã‰tape 1 : Sauvegarder
```bash
# Faire une copie complÃ¨te de l'ancien projet
cp -r ancien-projet ancien-projet-backup

# Sauvegarder la base de donnÃ©es
cp app.db app.db.backup
```

### âœ… Ã‰tape 2 : CrÃ©er la Structure
```bash
# CrÃ©er les dossiers
mkdir -p src/{config,database,models,services,middleware,routes}
mkdir -p backups public
```

### âœ… Ã‰tape 3 : Copier les Nouveaux Fichiers

**Fichiers Ã  crÃ©er** (dans l'ordre) :

1. **Configuration**
   - `src/config/index.js`
   - `src/config/zones.js`
   - `src/config/import-formats.js`

2. **Base de donnÃ©es**
   - `src/database/index.js`
   - `src/database/init.js`

3. **ModÃ¨les**
   - `src/models/schemas.js`

4. **Services**
   - `src/services/session.js`
   - `src/services/history.js`
   - `src/services/csv-parser.js`

5. **Middleware**
   - `src/middleware/index.js`
   - `src/middleware/auth.js`
   - `src/middleware/rate-limit.js`

6. **Routes** (toutes dans `src/routes/`)
   - `auth.js`
   - `lockers.js`
   - `clients.js`
   - `stats.js`
   - `export.js`
   - `import.js`
   - `backup.js`
   - `config.js`

7. **Utilitaires et backup**
   - `src/utils.js`
   - `src/backup.js`

8. **Fichier maÃ®tre**
   - `server.js`

### âœ… Ã‰tape 4 : VÃ©rifier les DÃ©pendances

```bash
# Installer les dÃ©pendances
npm install

# VÃ©rifier package.json
cat package.json
```

DÃ©pendances requises :
- `express` ^4.18.2
- `sqlite3` ^5.1.6
- `bcrypt` ^5.1.1
- `cors` ^2.8.5
- `cookie-parser` ^1.4.6
- `csurf` ^1.11.0
- `dotenv` ^16.3.1
- `express-rate-limit` ^7.1.5
- `helmet` ^7.1.0
- `zod` ^3.22.4

### âœ… Ã‰tape 5 : Conserver les Fichiers Existants

**Ne PAS toucher Ã  :**
- `config.env` (configuration existante)
- `app.db` (base de donnÃ©es)
- `backups/` (sauvegardes existantes)
- `public/` (frontend HTML/CSS/JS)

### âœ… Ã‰tape 6 : Tester la Migration

```bash
# DÃ©marrer le serveur
npm start

# VÃ©rifier dans les logs :
# âœ“ SQLite connectÃ©
# âœ“ Table casiers crÃ©Ã©e/vÃ©rifiÃ©e
# âœ“ Serveur dÃ©marrÃ©
```

## ğŸ” Comparaison des Structures

### Avant (fichier unique)

```
project/
â”œâ”€â”€ server.js (1500+ lignes)
â”œâ”€â”€ config.env
â”œâ”€â”€ app.db
â”œâ”€â”€ public/
â””â”€â”€ backups/
```

### AprÃ¨s (modulaire)

```
project/
â”œâ”€â”€ server.js (60 lignes)
â”œâ”€â”€ config.env
â”œâ”€â”€ app.db
â”œâ”€â”€ public/
â”œâ”€â”€ backups/
â””â”€â”€ src/
    â”œâ”€â”€ config/         (3 fichiers)
    â”œâ”€â”€ database/       (2 fichiers)
    â”œâ”€â”€ models/         (1 fichier)
    â”œâ”€â”€ services/       (3 fichiers)
    â”œâ”€â”€ middleware/     (3 fichiers)
    â”œâ”€â”€ routes/         (8 fichiers)
    â”œâ”€â”€ backup.js
    â””â”€â”€ utils.js
```

## ğŸ¯ Points d'Attention

### 1. Chemins de fichiers

**Avant :**
```javascript
// Dans server.js
const dbPath = path.join(__dirname, 'app.db');
```

**AprÃ¨s :**
```javascript
// Dans src/database/index.js
const dbPath = path.join(__dirname, '../../app.db');
```

### 2. Imports relatifs

**Avant :**
```javascript
// Tout dans le mÃªme fichier
```

**AprÃ¨s :**
```javascript
// Importer depuis les modules
const { dbRun } = require('../database');
const { requireAuth } = require('../middleware/auth');
```

### 3. Configuration CSRF

**Avant :**
```javascript
// csrfProtection global
const csrfProtection = csrf({...});
```

**AprÃ¨s :**
```javascript
// csrfProtection via req.app
const getCsrfProtection = (req) => req.app.get('csrfProtection');
```

## âœ… Tests de Validation

### Test 1 : Login
```bash
curl -X POST http://localhost:5000/api/login \
  -H "Content-Type: application/json" \
  -d '{"password":"", "userName":""}'
```

**RÃ©sultat attendu :** `{"success":true,"role":"guest"}`

### Test 2 : RÃ©cupÃ©rer les casiers
```bash
curl http://localhost:5000/api/lockers
```

**RÃ©sultat attendu :** Liste JSON des casiers

### Test 3 : Statistiques
```bash
curl http://localhost:5000/api/stats
```

**RÃ©sultat attendu :** Statistiques d'occupation

## ğŸ› RÃ©solution de ProblÃ¨mes

### Erreur : Module not found

```bash
# VÃ©rifier la structure des dossiers
ls -la src/

# VÃ©rifier que tous les fichiers sont crÃ©Ã©s
find src -name "*.js"
```

### Erreur : Cannot find database

```bash
# VÃ©rifier le chemin dans src/database/index.js
# Doit Ãªtre : path.join(__dirname, '../../app.db')
```

### Erreur : CSRF token invalid

```bash
# S'assurer que getCsrfProtection est utilisÃ© partout
# grep -r "csrfProtection" src/routes/
```

## ğŸ“Š VÃ©rification Finale

### Checklist de validation :

- [ ] Serveur dÃ©marre sans erreur
- [ ] Login admin fonctionne
- [ ] Login guest fonctionne
- [ ] Liste des casiers s'affiche
- [ ] Modification d'un casier fonctionne
- [ ] Import clients fonctionne
- [ ] Export fonctionne
- [ ] Backup manuel fonctionne
- [ ] Statistiques s'affichent
- [ ] Logs de connexion enregistrÃ©s

## ğŸ‰ Migration RÃ©ussie !

Si tous les tests passent, la migration est complÃ¨te. Vous pouvez maintenant :

1. **Supprimer l'ancien code** (gardez une copie de sÃ©curitÃ©)
2. **Commiter dans Git** :
   ```bash
   git add .
   git commit -m "Refactoring: Structure modulaire"
   ```
3. **Documenter les changements** pour l'Ã©quipe

## ğŸ“ Support

En cas de problÃ¨me :
1. VÃ©rifier les logs du serveur (VERBOSE = true)
2. Comparer avec l'ancien code
3. Restaurer depuis la sauvegarde si nÃ©cessaire

---

**Temps estimÃ© de migration** : 30-60 minutes  
**ComplexitÃ©** : Moyenne  
**Risque** : Faible (comportement identique)
